<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صندوق الرسائل - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f5f7fa; direction: rtl; }
        .inbox-item { transition: background-color 0.3s; }
        .inbox-item:hover { background-color: #f0f4f8; }
        .unread-indicator { width: 10px; height: 10px; background-color: #075e54; border-radius: 50%; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden">
        <header class="bg-blue-600 text-white p-4">
            <h1 class="text-xl font-bold text-center">صندوق الرسائل الواردة</h1>
        </header>

        <div id="inbox-list" class="divide-y divide-gray-200">
            <div id="loading" class="p-4 text-center text-gray-500">جاري تحميل المحادثات...</div>
            </div>

        <div id="no-chats" class="hidden p-4 text-center text-gray-500">
            <i class="fas fa-inbox text-3xl mb-2"></i>
            <p>لا توجد محادثات جديدة حاليًا.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


        const firebaseConfig = {
            // **هام:** استخدم إعدادات مشروعك هنا
            apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
            authDomain: "shaglni-c64c0.firebaseapp.com",
            projectId: "shaglni-c64c0",
            // ... بقية الإعدادات
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const realtimeDb = getDatabase(app);
        const firestoreDb = getFirestore(app); // للاستخدام في جلب اسم الشركة

        const inboxList = document.getElementById('inbox-list');
        const loadingIndicator = document.getElementById('loading');
        const noChats = document.getElementById('no-chats');
        
        let user;

        onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
                user = currentUser;
                listenForChats();
            } else {
                window.location.href = "../auth/login.html"; // توجيه للموظف لتسجيل الدخول
            }
        });

        // 2.2. جلب الشركات المشاركة في المحادثة (من Firestore)
        async function fetchPartnerDetails(partnerId) {
            // نفترض أن الطرف الآخر (الشركات) يتم تخزينها في مجموعة "companies" في Firestore
            try {
                const partnerDocRef = doc(firestoreDb, "companies", partnerId); 
                const partnerDocSnap = await getDoc(partnerDocRef);

                if (partnerDocSnap.exists()) {
                    const data = partnerDocSnap.data();
                    return {
                        name: data.name || 'شركة مجهولة',
                        profileImageUrl: data.logoUrl || 'https://via.placeholder.com/50'
                    };
                }
            } catch (error) {
                console.error("خطأ في جلب بيانات الشريك:", error);
            }
            return { name: 'شركة غير متوفرة', profileImageUrl: 'https://via.placeholder.com/50' };
        }

        // 2.3. دالة الاستماع لقائمة المحادثات
        function listenForChats() {
            const userChatsRef = ref(realtimeDb, `chats_by_user/${user.uid}`);

            onValue(userChatsRef, async (snapshot) => {
                loadingIndicator.classList.add('hidden');
                inboxList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    noChats.classList.remove('hidden');
                    return;
                }
                
                noChats.classList.add('hidden');
                
                const chatIds = snapshot.val();
                
                // جلب بيانات كل محادثة (رسالة أخيرة، حالة قراءة، إلخ)
                for (const chatId in chatIds) {
                    const participants = chatId.split('_');
                    // الطرف الآخر هو المعرف الذي ليس معرف المستخدم الحالي
                    const partnerId = participants.find(id => id !== user.uid); 
                    
                    const partnerDetails = await fetchPartnerDetails(partnerId);
                    
                    // سنحتاج إلى دالة لجلب آخر رسالة وحالة القراءة
                    fetchChatSummary(chatId, partnerId, partnerDetails);
                }
            });
        }
        
        // 2.4. دالة جلب ملخص المحادثة وعرضها
        function fetchChatSummary(chatId, partnerId, partnerDetails) {
            const messagesRef = ref(realtimeDb, `messages/${chatId}`);
            const lastReadRef = ref(realtimeDb, `chats_metadata/${chatId}/lastRead/${user.uid}`);

            // الاستماع فقط لآخر رسالة وتاريخ القراءة للمستخدم الحالي
            onValue(messagesRef, (messagesSnapshot) => {
                if (!messagesSnapshot.exists()) return;

                const messagesData = messagesSnapshot.val();
                const messages = Object.keys(messagesData).map(key => messagesData[key]);
                messages.sort((a, b) => b.timestamp - a.timestamp); // ترتيب تنازلي

                const lastMessage = messages[0];
                
                // جلب آخر قراءة للموظف
                onValue(lastReadRef, (lastReadSnapshot) => {
                    const lastReadTimestamp = lastReadSnapshot.val() || 0;
                    
                    // تحديد ما إذا كانت هناك رسائل غير مقروءة (من طرف الشركة)
                    const hasUnread = lastMessage.senderId === partnerId && lastMessage.timestamp > lastReadTimestamp;
                    
                    renderInboxItem(chatId, partnerId, partnerDetails, lastMessage, hasUnread);
                }, { onlyOnce: true }); // جلب حالة القراءة لمرة واحدة
            });
        }

        // 2.5. دالة عرض عنصر صندوق الوارد
        function renderInboxItem(chatId, partnerId, partnerDetails, lastMessage, hasUnread) {
            const existingItem = document.getElementById(`chat-${chatId}`);
            if (existingItem) {
                existingItem.remove(); // تحديث العنصر بدلاً من إضافته مرة أخرى
            }

            const item = document.createElement('a');
            item.id = `chat-${chatId}`;
            item.href = `employee_chat.html?companyId=${partnerId}&companyName=${encodeURIComponent(partnerDetails.name)}&companyPhoto=${encodeURIComponent(partnerDetails.profileImageUrl)}`;
            item.classList.add('inbox-item', 'flex', 'items-center', 'p-4', 'cursor-pointer');
            
            // تنسيق الوقت
            const timeAgo = formatTimeAgo(lastMessage.timestamp);
            
            // إنشاء المحتوى
            item.innerHTML = `
                <img src="${partnerDetails.profileImageUrl}" alt="${partnerDetails.name}" class="w-12 h-12 rounded-full ml-4 object-cover">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-gray-900 truncate">${partnerDetails.name}</p>
                        <span class="text-xs text-gray-500">${timeAgo}</span>
                    </div>
                    <p class="text-sm ${hasUnread ? 'font-bold text-gray-800' : 'text-gray-500'} truncate mt-1">
                        ${lastMessage.text}
                    </p>
                </div>
                ${hasUnread ? '<div class="unread-indicator mr-2"></div>' : ''}
            `;
            
            inboxList.prepend(item); // إضافة الأحدث في الأعلى
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'الآن';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} د`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} س`;
            
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
        }

    </script>
</body>
</html>
