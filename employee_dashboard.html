<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الموظف - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root {
            --primary: #2563eb; /* Blue-600 */
            --primary-light: #eff6ff; /* Blue-50 */
            --secondary: #f59e0b; /* Amber-500 */
            --success: #10b981; /* Green-500 */
            --danger: #ef4444; /* Red-500 */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f5f7fa; /* Light Gray Background */
        }

        /* تخصيص الشريط الجانبي */
        .sidebar {
            width: 280px;
            transition: all 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        .sidebar-link.active {
            background-color: var(--primary-light);
            color: var(--primary);
            border-right: 4px solid var(--primary);
        }

        /* تباعد المحتوى الرئيسي ليناسب الشريط الجانبي في RTL */
        .main-content {
            margin-right: 280px;
        }

        /* كرت الوظيفة المقترحة */
        .job-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="sidebar fixed top-0 right-0 h-full bg-white p-6 flex flex-col z-10">
        <div class="flex items-center justify-center mb-10 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900">شغلني<span class="text-blue-600">.</span></h1>
        </div>

        <nav class="flex-grow space-y-2">
            <a href="#" class="sidebar-link active flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-chart-line w-5 h-5 ml-3"></i>
                <span>لوحة التحكم الرئيسية</span>
            </a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-user-circle w-5 h-5 ml-3"></i>
                <span>ملفي الشخصي</span>
            </a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-search w-5 h-5 ml-3"></i>
                <span>البحث عن وظيفة</span>
            </a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-paper-plane w-5 h-5 ml-3"></i>
                <span>طلبات التقديم</span>
                <span class="mr-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full" id="pending-applications-badge">3</span>
            </a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-bookmark w-5 h-5 ml-3"></i>
                <span>وظائف محفوظة</span>
            </a>
        </nav>

        <div class="pt-6 border-t mt-6">
            <a href="#" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">
                <i class="fas fa-cog w-5 h-5 ml-3"></i>
                <span>الإعدادات</span>
            </a>
            <a href="#" class="flex items-center p-3 rounded-lg text-red-600 hover:bg-red-50 font-medium" id="logout-button">
                <i class="fas fa-sign-out-alt w-5 h-5 ml-3"></i>
                <span>تسجيل الخروج</span>
            </a>
        </div>
    </aside>

    <div class="main-content flex-grow p-8">

        <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
            <h2 class="text-2xl font-bold text-gray-800" id="welcome-message">مرحباً بك يا أحمد!</h2> 
            <div class="flex items-center space-x-4 space-x-reverse">
                <button class="relative p-2 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-bell text-xl"></i>
                    <span class="absolute top-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-red-500"></span>
                </button>
                <div class="flex items-center space-x-3 space-x-reverse">
                    <span class="text-gray-700 font-medium hidden sm:block" id="user-name-display">أحمد علي</span> 
                    <img id="profile-picture" class="h-10 w-10 rounded-full object-cover border-2 border-blue-500" src="https://via.placeholder.com/150/2563eb/ffffff?text=A" alt="صورة الملف الشخصي">
                </div>
            </div>
        </header>

        <main class="space-y-8">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600">
                    <div class="flex items-center">
                        <i class="fas fa-paper-plane text-3xl text-blue-600 ml-4"></i>
                        <div>
                            <p class="text-sm text-gray-500">عدد الطلبات المرسلة</p>
                            <p id="applications-count" class="text-3xl font-extrabold text-gray-900">12</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <div class="flex items-center">
                        <i class="fas fa-eye text-3xl text-green-600 ml-4"></i>
                        <div>
                            <p class="text-sm text-gray-500">مشاهدات ملفك هذا الأسبوع</p>
                            <p id="views-count" class="text-3xl font-extrabold text-gray-900">45</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-amber-600">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-3xl text-amber-600 ml-4"></i>
                        <div>
                            <p class="text-sm text-gray-500">عروض العمل/القبول</p>
                            <p id="accepted-count" class="text-3xl font-extrabold text-gray-900">2</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">حالة الملف الشخصي</h3>
                        <span id="profile-completion" class="text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">90% مكتمل</span>
                    </div>
                    <p class="text-gray-600 text-sm">أضف 5 صور أخرى من أعمالك لرفع نسبة الإكمال والحصول على فرص أكبر.</p>
                    <button class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-150">
                        تحديث ملفي الآن
                    </button>
                </div>
                
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">آخر التنبيهات والإشعارات</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start text-gray-700">...</li>
                        <li class="flex items-start text-gray-700">...</li>
                        <li class="flex items-start text-gray-700">...</li>
                    </ul>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex justify-between items-center">
                    الوظائف المقترحة لك
                    <a href="#" class="text-blue-600 text-sm hover:underline">عرض الكل <i class="fas fa-arrow-left mr-2 text-xs"></i></a>
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="job-card bg-gray-50 p-4 rounded-lg border border-gray-200">...</div>
                    <div class="job-card bg-gray-50 p-4 rounded-lg border border-gray-200">...</div>
                    <div class="job-card bg-gray-50 p-4 rounded-lg border border-gray-200">...</div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // 1. استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 2. إعدادات Firebase (يجب استبدالها بمعلومات مشروعك)
        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk", 
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com", 
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819", 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. الدوال المساعدة لتحديث الواجهة
        
        function updateUserName(name) {
            document.getElementById('welcome-message').textContent = `مرحباً بك يا ${name}!`;
            document.getElementById('user-name-display').textContent = name;
        }

        function updateProfilePicture(url, name) {
            const imgElement = document.getElementById('profile-picture');
            if (url) {
                imgElement.src = url;
                imgElement.alt = `صورة الملف الشخصي لـ ${name}`;
            } else {
                const initial = name ? name.charAt(0) : 'A';
                imgElement.src = `https://via.placeholder.com/150/2563eb/ffffff?text=${initial}`;
            }
        }
        
        function updateStats(userData) {
            // يتم تعيين القيمة إلى البيانات الحقيقية من Firestore، أو 0 إذا كانت غير موجودة
            document.getElementById('applications-count').textContent = userData.applicationsCount || 0; 
            document.getElementById('views-count').textContent = userData.viewsCount || 0;
            document.getElementById('accepted-count').textContent = userData.acceptedCount || 0; 
            
            // تحديث شارة الطلبات المعلقة في الشريط الجانبي
            document.getElementById('pending-applications-badge').textContent = userData.applicationsCount || 0; 
        
            // تحديث حالة إكمال الملف الشخصي (نفترض وجود حقل profileCompletion)
            const completion = userData.profileCompletion || 0;
            document.getElementById('profile-completion').textContent = `${completion}% مكتمل`;
        }

        // 4. الدالة الرئيسية لحماية الصفحة وجلب البيانات
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // المستخدم مسجل الدخول، نبدأ جلب البيانات
                const userDocRef = doc(db, "employees", user.uid); 
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().role === 'employee') {
                    const userData = userDoc.data();
                    
                    const userName = userData.name || "مستخدمنا العزيز";
                    updateUserName(userName);
                    updateProfilePicture(userData.profileImageUrl, userName);
                    updateStats(userData); 
                    
                } else {
                    // المستخدم ليس موظفاً أو لا توجد وثيقة له، نقوم بتسجيل الخروج
                    alert("يبدو أن هذا الحساب ليس حساب موظف. سيتم توجيهك لتسجيل الدخول.");
                    await signOut(auth);
                    window.location.href = "login.html"; 
                }
            } else {
                // المستخدم غير مسجل الدخول
                alert("الرجاء تسجيل الدخول أولاً للوصول إلى لوحة التحكم.");
                window.location.href = "login.html"; 
            }
        });

        // 5. وظيفة تسجيل الخروج
        document.getElementById('logout-button').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                window.location.href = "login.html"; 
            } catch (error) {
                console.error("خطأ في تسجيل الخروج:", error);
                alert("حدث خطأ أثناء تسجيل الخروج. حاول مرة أخرى.");
            }
        });

    </script>
</body>
</html>
