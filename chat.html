<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المحادثة - شغلني</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="bg-white shadow-lg p-4 flex items-center justify-between sticky top-0 z-10">
        <div class="flex items-center space-x-4 rtl:space-x-reverse">
            <button onclick="window.history.back()" class="text-gray-600 hover:text-blue-600">
                <i class="fas fa-arrow-right text-xl"></i>
            </button>
            <div class="flex-shrink-0">
                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="صورة الملف الشخصي" class="w-10 h-10 rounded-full">
            </div>
            <div>
                <h2 class="font-bold text-gray-800" id="recipientName"></h2>
                <p class="text-sm text-gray-500">متصل الآن</p>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 chat-container" id="messagesContainer">
        </main>

    <footer class="bg-white p-4 shadow-lg sticky bottom-0">
        <form id="messageForm" class="flex items-center space-x-2 rtl:space-x-reverse">
            <input type="text" id="messageInput" placeholder="اكتب رسالتك..."
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // قم بتعديل هذا الجزء بمعلومات مشروعك
        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.firebasestorage.app",
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819",
          measurementId: "G-98GQGZS09W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        
        let currentUser;
        let recipientId;
        let chatId;

        // الحصول على ID الموظف من الرابط
        const urlParams = new URLSearchParams(window.location.search);
        recipientId = urlParams.get('employeeId');

        // التحقق من حالة تسجيل الدخول
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // بعد تسجيل الدخول، يمكننا الآن تحديد مسار المحادثة
                if (recipientId) {
                    await setupChat();
                    listenForMessages();
                    await getRecipientInfo();
                }
            } else {
                alert('الرجاء تسجيل الدخول أولاً.');
                // توجيه المستخدم إلى صفحة تسجيل الدخول
                window.location.href = 'login.html'; 
            }
        });

        // إعداد المحادثة (تحديد chatId)
        async function setupChat() {
            // إنشاء chatId فريد بناءً على id المستخدمين
            const users = [currentUser.uid, recipientId].sort();
            chatId = users.join('_');
        }

        // جلب معلومات الموظف (الاسم، الصورة، إلخ.)
        async function getRecipientInfo() {
            try {
                const docRef = doc(db, "employees", recipientId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const recipientName = docSnap.data().name;
                    document.getElementById('recipientName').textContent = recipientName;
                    // يمكنك تحديث الصورة هنا أيضاً
                }
            } catch (error) {
                console.error("خطأ في جلب بيانات الموظف:", error);
            }
        }

        // الاستماع للرسائل الجديدة في الوقت الفعلي
        function listenForMessages() {
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("timestamp"));

            onSnapshot(q, (snapshot) => {
                // إزالة جميع الرسائل القديمة قبل إضافة الجديدة
                messagesContainer.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    displayMessage(message);
                });
                // تمرير الشاشة إلى آخر رسالة
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, (error) => {
                console.error("خطأ في الاستماع للرسائل:", error);
            });
        }
        
        // إرسال الرسالة
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText === '') return;

            const newMessage = {
                senderId: currentUser.uid,
                recipientId: recipientId,
                text: messageText,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "chats", chatId, "messages"), newMessage);
                messageInput.value = '';
            } catch (error) {
                console.error("خطأ في إرسال الرسالة:", error);
                alert("فشل إرسال الرسالة. الرجاء المحاولة مرة أخرى.");
            }
        });
        
        // عرض الرسالة في الواجهة
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'mb-2');

            // تحديد ما إذا كانت الرسالة مرسلة أم مستلمة
            if (message.senderId === currentUser.uid) {
                // رسالة مرسلة
                messageElement.classList.add('justify-end');
                messageElement.innerHTML = `
                    <div class="bg-blue-600 text-white rounded-t-xl rounded-bl-xl p-3 max-w-sm">
                        <p>${message.text}</p>
                    </div>
                `;
            } else {
                // رسالة مستلمة
                messageElement.classList.add('justify-start');
                messageElement.innerHTML = `
                    <div class="bg-gray-200 text-gray-800 rounded-t-xl rounded-br-xl p-3 max-w-sm">
                        <p>${message.text}</p>
                    </div>
                `;
            }
            messagesContainer.appendChild(messageElement);
        }
    </script>
</body>
</html>
