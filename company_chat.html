<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محادثة مع الموظف - شغلني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .message-box {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/4c6ac0b9-d0f3-4546-89b8-cf881347ac80.png" alt="شعار موقع شغلني" class="h-10 mr-2">
                        <span class="text-xl font-bold text-blue-600">شغلني</span>
                    </a>
                </div>
                <div class="mr-4">
                    <a href="login.html" class="px-4 py-2 text-blue-600 font-medium border border-blue-600 rounded-lg hover:bg-blue-50 whitespace-nowrap">تسجيل الدخول</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="flex-1 flex flex-col p-6">
        <div class="bg-white rounded-t-xl shadow-md p-4 flex items-center justify-between border-b border-gray-200">
            <div class="flex items-center">
                <img id="employee-photo" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/d57596e8-de87-47ed-adc1-9d31d60207f3.png" alt="صورة الموظف" class="w-12 h-12 rounded-full object-cover ml-3">
                <div>
                    <h2 id="employee-name" class="text-xl font-bold text-gray-800">أحمد محمد</h2>
                    <p id="job-title" class="text-sm text-gray-500">مراسلة بخصوص وظيفة: **محاسب مالي**</p>
                    <p id="application-status" class="text-sm font-semibold text-yellow-500 mt-1">حالة الطلب: قيد المراجعة</p>
                </div>
            </div>
            <div class="flex space-x-2 space-x-reverse">
                <a id="view-profile-btn" href="#" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-300">عرض الملف الشخصي</a>
                <button id="send-offer-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700">إرسال عرض عمل</button>
            </div>
        </div>

        <div id="message-box" class="message-box flex-1 bg-white p-6 overflow-y-auto rounded-b-xl shadow-md">
            </div>

        <form id="message-form" class="mt-4 p-4 bg-white rounded-xl shadow-md flex items-center">
            <input id="message-input" type="text" placeholder="اكتب رسالتك هنا..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 ml-2">
            <button type="submit" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition duration-300">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <div id="offer-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[100]">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold text-gray-900 mb-4">إرسال عرض عمل</h3>
            <form id="offer-form">
                <div class="mb-4">
                    <label for="offer-salary" class="block text-sm font-medium text-gray-700">الراتب المقترح</label>
                    <input type="number" id="offer-salary" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="مثال: 10000" required>
                </div>
                <div class="mb-4">
                    <label for="offer-details" class="block text-sm font-medium text-gray-700">تفاصيل إضافية</label>
                    <textarea id="offer-details" rows="4" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="اكتب هنا شروط العقد، المزايا، إلخ."></textarea>
                </div>
                <div class="flex justify-end space-x-2 space-x-reverse">
                    <button type="button" id="close-offer-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">إرسال العرض</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // **1. تهيئة Firebase - بيانات مشروعك**
        const firebaseConfig = {
            apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
            authDomain: "shaglni-c64c0.firebaseapp.com",
            projectId: "shaglni-c64c0",
            storageBucket: "shaglni-c64c0.firebasestorage.app",
            messagingSenderId: "768887356636",
            appId: "1:768887356636:web:d836c1d5d30167279c8819",
            measurementId: "G-5P0MNGPMG0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // **2. ربط عناصر الواجهة**
        const messageBox = document.getElementById('message-box');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const employeeNameEl = document.getElementById('employee-name');
        const employeePhotoEl = document.getElementById('employee-photo');
        const jobTitleEl = document.getElementById('job-title');
        const applicationStatusEl = document.getElementById('application-status');
        const sendOfferBtn = document.getElementById('send-offer-btn');
        const offerModal = document.getElementById('offer-modal');
        const closeOfferModalBtn = document.getElementById('close-offer-modal');
        const offerForm = document.getElementById('offer-form');

        let currentChatId = null;
        let employeeId = null;
        let jobId = null;
        let currentJobTitle = "";

        // **3. استخراج البيانات من URL (طريقة ديناميكية)**
        const urlParams = new URLSearchParams(window.location.search);
        currentChatId = urlParams.get('chatId');
        employeeId = urlParams.get('employeeId');
        jobId = urlParams.get('jobId');

        // **4. تحديث واجهة المحادثة ببيانات الموظف والوظيفة**
        async function updateChatHeader() {
            if (employeeId) {
                const employeeRef = doc(db, "employees", employeeId); // تأكد من اسم مجموعة الموظفين
                const employeeSnap = await getDoc(employeeRef);
                if (employeeSnap.exists()) {
                    const employeeData = employeeSnap.data();
                    employeeNameEl.textContent = employeeData.name;
                    employeePhotoEl.src = employeeData.photoUrl;
                }
            }
            if (jobId) {
                const jobRef = doc(db, "jobs", jobId); // تأكد من اسم مجموعة الوظائف
                const jobSnap = await getDoc(jobRef);
                if (jobSnap.exists()) {
                    const jobData = jobSnap.data();
                    jobTitleEl.textContent = `مراسلة بخصوص وظيفة: **${jobData.title}**`;
                    currentJobTitle = jobData.title;
                }
            }
            // يجب تحديث حالة الطلب من مكان آخر، ربما من وثيقة التقديم
            applicationStatusEl.textContent = "حالة الطلب: قيد المراجعة";
        }

        // **5. عرض الرسائل من Firestore**
        function displayMessages(chatId) {
            const messagesQuery = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp"));

            onSnapshot(messagesQuery, (snapshot) => {
                messageBox.innerHTML = '';
                snapshot.forEach((doc) => {
                    const messageData = doc.data();
                    const messageElement = document.createElement('div');
                    const isMyMessage = messageData.senderId === auth.currentUser.uid;
                    messageElement.classList.add('flex', 'mb-4', isMyMessage ? 'justify-end' : 'justify-start');

                    let messageContent;
                    // Check if it's a job offer
                    if (messageData.type === 'job_offer') {
                        messageContent = `
                            <div class="bg-white border-4 border-green-500 p-4 rounded-lg shadow-md max-w-sm">
                                <h5 class="font-bold text-green-700 text-lg mb-2">عرض عمل جديد</h5>
                                <p class="text-gray-800 mb-2">
                                    تهانينا، نقدم لك عرض عمل لوظيفة **${messageData.jobTitle}** براتب شهري قدره **${messageData.salary}**.
                                    يرجى الرد على هذا العرض خلال 72 ساعة.
                                </p>
                                <p class="text-gray-600 text-sm italic mb-2">${messageData.details}</p>
                                <div class="flex justify-start space-x-2 space-x-reverse mt-4">
                                    <button class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">قبول</button>
                                    <button class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">رفض</button>
                                </div>
                            </div>
                        `;
                    } else { // It's a regular message
                        messageContent = `
                            <div class="bg-${isMyMessage ? 'blue-600' : 'gray-200'} text-${isMyMessage ? 'white' : 'gray-800'} p-3 rounded-lg max-w-sm">
                                <p>${messageData.text}</p>
                            </div>
                        `;
                    }
                    messageElement.innerHTML = messageContent;
                    messageBox.appendChild(messageElement);
                });
                messageBox.scrollTop = messageBox.scrollHeight;
            });
        }

        // **6. إرسال رسالة جديدة**
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText === '') return;
            if (auth.currentUser && currentChatId) {
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    senderId: auth.currentUser.uid,
                    text: messageText,
                    timestamp: serverTimestamp(),
                    type: 'text'
                });
                messageInput.value = '';
            } else {
                alert("يجب تسجيل الدخول وبدء محادثة لإرسال الرسائل.");
            }
        });

        // **7. منطق عرض وإرسال عرض العمل (Modal)**
        sendOfferBtn.addEventListener('click', () => {
            offerModal.classList.remove('hidden');
        });
        closeOfferModalBtn.addEventListener('click', () => {
            offerModal.classList.add('hidden');
        });
        offerModal.addEventListener('click', (e) => {
            if (e.target === offerModal) {
                offerModal.classList.add('hidden');
            }
        });

        offerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const salary = document.getElementById('offer-salary').value;
            const details = document.getElementById('offer-details').value;

            if (auth.currentUser && currentChatId && salary) {
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    senderId: auth.currentUser.uid,
                    jobTitle: currentJobTitle,
                    salary: salary,
                    details: details,
                    timestamp: serverTimestamp(),
                    type: 'job_offer'
                });

                // Update application status to "تم القبول" or similar
                // const applicationRef = doc(db, "applications", jobId, employeeId); // You need a structured way to access this
                // await updateDoc(applicationRef, { status: 'عرض عمل' });

                offerModal.classList.add('hidden');
                offerForm.reset();
            } else {
                alert("يرجى إدخال الراتب و التأكد من تسجيل الدخول.");
            }
        });

        // **8. عند تحميل الصفحة، ابدأ بعرض الرسائل**
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (currentChatId) {
                    updateChatHeader();
                    displayMessages(currentChatId);
                } else {
                    alert("خطأ: لم يتم تحديد محادثة.");
                    window.location.href = "company_dashboard.html"; // إعادة التوجيه
                }
            } else {
                window.location.href = "login.html";
            }
        });
    </script>
</body>
</html>
